# 0007 删档测试下移除兼容逻辑并简化存储

- 日期: 2026-01-05
- 状态: active
- 负责人: AI
- 变更类型: refactor
- 影响范围: utils/storage.py, core/agent.py, core/llm/base.py, readme.md
- 关联: 删档测试准备
- 约束与风险: 现有数据库/旧 JSON 数据不再自动迁移，需要手动清理或重新初始化
- 环境/版本: N/A

## 0. 问题/目标 (Context)
准备进行删档测试，当前代码仍保留了旧数据格式和目录迁移的兼容逻辑，增加了运行路径复杂度。目标是移除这些冗余兼容并简化存储结构，确保新环境行为清晰。

## 1. 方案对比 (Options)
### 方案 A
- 优点: 保持兼容，旧数据无需手动处理
- 缺点: 运行路径复杂、维护成本高
- 成本: 持续维护迁移与回退分支

### 方案 B
- 优点: 结构更清晰，路径更短，行为更可控
- 缺点: 旧数据需要人工清理或重新初始化
- 成本: 一次性割舍历史兼容

## 2. 决策 (Decision)
选择方案 B。删档测试以全新数据为前提，优先简化代码与路径，避免冗余分支带来的维护负担。

## 3. 设计与实现 (Design & Implementation)
- 移除 SQLite schema/json 迁移逻辑与旧 JSON 文件回退路径。
- 去掉默认记忆目录的旧文件迁移，直接按 `data/memory_bank/<user_id>/` 组织。
- 统一短期记忆角色为 `assistant`，取消 `model` 角色兼容映射。
- 更新 README 的记忆文件说明。

## 4. 实验与效果 (Experiment & Result)
N/A（本次为结构性清理，待删档后验证）。

## 5. 测试与优化 (Tests & Optimization)
- [ ] 单元测试: N/A
- [ ] 集成测试: N/A
- [ ] 手动验证: N/A
- 结果/备注: 未执行测试。

## 6. 结论与收获 (Lessons)
删档测试场景下，兼容逻辑会放大维护复杂度。明确清理边界并统一数据格式，有助于减少隐性分支与误用风险。

## 7. 后续行动 (Next)
N/A。
